name: Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "VOICEVOX Editor ÁöÑÁâàÊú¨‰ø°ÊÅØ (‰æãÂ¶ÇÔºö0.21.1)"
        required: true
      prerelease:
        description: "ÊòØÂê¶‰∏∫È¢ÑÂèëÂ∏ÉÁâàÊú¨"
        type: boolean
        default: true
      code_signing:
        description: "ÊòØÂê¶ËøõË°å‰ª£Á†ÅÁ≠æÂêç"
        type: boolean
        default: false
      upload_artifact:
        description: "ÊòØÂê¶Â∞ÜÊûÑÂª∫‰∫ßÁâ©‰∏ä‰º†‰∏∫ Artifacts (Áî®‰∫éË∞ÉËØï)"
        type: boolean
        default: false
      voicevox_engine_version:
        description: "VOICEVOX Engine ÁâàÊú¨„ÄÇÂ°´ `latest` Ëá™Âä®ÊäìÂèñ"
        required: false
        default: "latest"
      voicevox_resource_version:
        description: "VOICEVOX Resource ÁâàÊú¨„ÄÇÂ°´ `latest` Ëá™Âä®ÊäìÂèñ"
        required: false
        default: "latest"

env:
  VOICEVOX_ENGINE_VERSION: ${{ github.event.inputs.voicevox_engine_version || 'latest' }}
  VOICEVOX_RESOURCE_VERSION: ${{ github.event.inputs.voicevox_resource_version || 'latest' }}
  VOICEVOX_EDITOR_VERSION: ${{ github.event.release.tag_name || github.event.inputs.version || '999.999.999-develop' }}

defaults:
  run:
    shell: bash
    
permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact_name: linux-nvidia-prepackage
            artifact_path: dist_electron/linux-unpacked
            voicevox_engine_asset_name: linux-nvidia
            package_name: voicevox
            compressed_artifact_name: voicevox-linux-nvidia
            app_asar_dir: prepackage/resources
            installer_artifact_name: linux-nvidia-appimage
            linux_artifact_name: "VOICEVOX.${ext}"
            linux_executable_name: voicevox
            linux_appimage_7z_name: VOICEVOX.AppImage
            os: ubuntu-22.04
          - artifact_name: linux-cpu-x64-prepackage
            artifact_path: dist_electron/linux-unpacked
            voicevox_engine_asset_name: linux-cpu-x64
            package_name: voicevox-cpu
            compressed_artifact_name: voicevox-linux-cpu-x64
            app_asar_dir: prepackage/resources
            installer_artifact_name: linux-cpu-x64-appimage
            linux_artifact_name: "VOICEVOX.${version}-x64.${ext}"
            linux_executable_name: voicevox
            linux_appimage_7z_name: VOICEVOX-CPU-X64.AppImage
            os: ubuntu-22.04
          - artifact_name: linux-cpu-arm64-prepackage
            artifact_path: dist_electron/linux-arm64-unpacked
            voicevox_engine_asset_name: linux-cpu-arm64
            package_name: voicevox-cpu
            compressed_artifact_name: voicevox-linux-cpu-arm64
            app_asar_dir: prepackage/resources
            installer_artifact_name: linux-cpu-arm64-appimage
            linux_artifact_name: "VOICEVOX.${version}-arm64.${ext}"
            linux_executable_name: voicevox
            linux_appimage_7z_name: VOICEVOX-CPU-ARM64.AppImage
            os: ubuntu-22.04-arm
          - artifact_name: windows-nvidia-prepackage
            artifact_path: dist_electron/win-unpacked
            voicevox_engine_asset_name: windows-nvidia
            package_name: voicevox-cuda
            compressed_artifact_name: voicevox-windows-nvidia
            app_asar_dir: prepackage/resources
            installer_artifact_name: windows-nvidia-nsis-web
            nsis_web_artifact_name: "VOICEVOX-CUDA.Web.Setup.${version}.${ext}"
            os: windows-2022
          - artifact_name: windows-cpu-prepackage
            artifact_path: dist_electron/win-unpacked
            voicevox_engine_asset_name: windows-cpu
            package_name: voicevox-cpu
            compressed_artifact_name: voicevox-windows-cpu
            app_asar_dir: prepackage/resources
            installer_artifact_name: windows-cpu-nsis-web
            nsis_web_artifact_name: "VOICEVOX-CPU.Web.Setup.${version}.${ext}"
            os: windows-2022
          - artifact_name: windows-directml-prepackage
            artifact_path: dist_electron/win-unpacked
            voicevox_engine_asset_name: windows-directml
            package_name: voicevox
            compressed_artifact_name: voicevox-windows-directml
            app_asar_dir: prepackage/resources
            installer_artifact_name: windows-directml-nsis-web
            nsis_web_artifact_name: "VOICEVOX.Web.Setup.${version}.${ext}"
            os: windows-2022
          - artifact_name: macos-cpu-x64-prepackage
            artifact_path: dist_electron/mac
            voicevox_engine_asset_name: macos-x64
            package_name: voicevox-cpu
            compressed_artifact_name: voicevox-macos-cpu-x64
            app_asar_dir: prepackage/VOICEVOX.app/Contents/Resources
            installer_artifact_name: macos-cpu-x64-dmg
            macos_artifact_name: "VOICEVOX.${version}-x64.${ext}"
            os: macos-15-intel
          - artifact_name: macos-cpu-arm64-prepackage
            artifact_path: dist_electron/mac-arm64
            voicevox_engine_asset_name: macos-arm64
            package_name: voicevox-cpu
            compressed_artifact_name: voicevox-macos-cpu-arm64
            app_asar_dir: prepackage/VOICEVOX.app/Contents/Resources
            installer_artifact_name: macos-cpu-arm64-dmg
            macos_artifact_name: "VOICEVOX.${version}-arm64.${ext}"
            os: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".node-version"
          cache: "pnpm"

      - name: Install dependencies & Translation
        run: |
          pnpm i --no-frozen-lockfile
          # üí° Ëß£ÂÜ≥ Linux Â§ßÂ∞èÂÜôÊïèÊÑüÂØºËá¥ÁöÑËÑöÊú¨Êâæ‰∏çÂà∞ÈóÆÈ¢ò
          if [ -f "script/zh-cn.js" ]; then
            node script/zh-cn.js
          elif [ -f "scripts/zh-cn.js" ]; then
            node scripts/zh-cn.js
          else
            echo "‚ö†Ô∏è Warning: zh-cn.js not found in script/ or scripts/"
          fi

      - name: Resolve VOICEVOX Resource Version
        id: resolve-resource
        run: |
          VERSION="${{ env.VOICEVOX_RESOURCE_VERSION }}"
          if [ "$VERSION" = "latest" ]; then
            VERSION=$(gh release --repo VOICEVOX/voicevox_resource view --json tagName --template '{{.tagName}}')
          fi
          echo "resolved_version=$VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout Resource
        uses: actions/checkout@v4
        with:
          repository: VOICEVOX/voicevox_resource
          ref: ${{ steps.resolve-resource.outputs.resolved_version }}
          path: resource

      - name: Download Engine
        uses: ./.github/actions/download-engine
        with:
          version: ${{ env.VOICEVOX_ENGINE_VERSION }}
          dest: ${{ github.workspace }}/voicevox_engine
          target: ${{ matrix.voicevox_engine_asset_name }}

      - name: Build Electron
        run: pnpm run electron:build --dir
        env:
          USE_HARD_LINKS: false

      - name: Prepare Prepackage
        run: mv ${{ matrix.artifact_path }} ./prepackage

      - name: Merge Engine into Prepackage
        run: |
          if [[ "${{ matrix.os }}" == macos-* ]]; then
            mv voicevox_engine/ prepackage/VOICEVOX.app/Contents/Resources/vv-engine/
          else
            mv voicevox_engine/ prepackage/vv-engine/
          fi

      - name: Compress Output
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            7z a "${{ matrix.compressed_artifact_name }}.zip" ./prepackage/*
          else
            # Linux/Mac ‰ΩøÁî® zip ‰øùÊåÅÊùÉÈôê
            cd prepackage && zip -r "../${{ matrix.compressed_artifact_name }}.zip" ./*
          fi

      - name: Upload Artifact (Debug)
        if: github.event.inputs.upload_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.compressed_artifact_name }}.zip

      - name: Create Release and Upload
        if: (github.event.release.tag_name || github.event.inputs.version) != ''
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ github.event.inputs.prerelease }}
          tag_name: ${{ env.VOICEVOX_EDITOR_VERSION }}
          files: |
            *.zip
            dist_electron/*.dmg
            dist_electron/*.exe
            dist_electron/*.AppImage
          target_commitish: ${{ github.sha }}
