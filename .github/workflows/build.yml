name: Build

on:
  push:
    branches:
      - main
  release:
    types:
      - created
  workflow_dispatch:
    inputs:
      voicevox_resource_version:
        description: 'VOICEVOX 的版本（原版）'
        required: false
        default: '0.25.0'
      voicevox_editor_version:
        description: 'VOICEVOX的新版本（汉化）'
        required: false
        default: ''
      prerelease:
        description: '是否为预发布版本'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  VOICEVOX_ENGINE_VERSION: ${{ github.event.inputs.voicevox_engine_version || '' }}
  VOICEVOX_RESOURCE_VERSION: ${{ github.event.inputs.voicevox_resource_version || '' }}
  VOICEVOX_EDITOR_VERSION: ${{ github.event.release.tag_name || github.event.inputs.voicevox_editor_version }}
  ELECTRON_CACHE: .cache/electron
  ELECTRON_BUILDER_CACHE: .cache/electron-builder
  cache-version: v2
  sed: sed
  PNPM_HOME: C:\Users\runneradmin\setup-pnpm\node_modules\.bin # 针对 Windows runner
  TEMPDIR: D:/a/_temp/download-engine
  DEST: D:/a/VOICEVOX/VOICEVOX/voicevox_engine

defaults:
  run:
    shell: bash

jobs:
  build-and-upload:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        artifact_name:
          - windows-cpu
          - windows-directml
          - windows-nvidia
          - linux-cpu-x64
          - linux-cpu-arm64
          - linux-nvidia
          - macos-cpu-x64
          - macos-cpu-arm64
        include:
          - os: windows-latest
            artifact_name: windows-cpu
            compressed_artifact_name: voicevox-windows-cpu
          - os: windows-latest
            artifact_name: windows-directml
            compressed_artifact_name: voicevox-windows-directml
          - os: windows-latest
            artifact_name: windows-nvidia
            compressed_artifact_name: voicevox-windows-nvidia
          - os: ubuntu-latest
            artifact_name: linux-cpu-x64
            compressed_artifact_name: voicevox-linux-cpu-x64
          - os: ubuntu-latest
            artifact_name: linux-cpu-arm64
            compressed_artifact_name: voicevox-linux-cpu-arm64
          - os: ubuntu-latest
            artifact_name: linux-nvidia
            compressed_artifact_name: voicevox-linux-nvidia
          - os: macos-latest
            artifact_name: macos-cpu-x64
            compressed_artifact_name: voicevox-macos-cpu-x64
          - os: macos-latest
            artifact_name: macos-cpu-arm64
            compressed_artifact_name: voicevox-macos-cpu-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Download VOICEVOX Engine
        run: |
          mkdir -p "${{ env.TEMPDIR }}"
          curl -L "https://github.com/VOICEVOX/voicevox_engine/releases/download/${{ env.VOICEVOX_ENGINE_VERSION }}/voicevox_engine-${{ matrix.artifact_name }}.zip" -o "${{ env.TEMPDIR }}/voicevox_engine.zip"
          unzip "${{ env.TEMPDIR }}/voicevox_engine.zip" -d "${{ env.DEST }}"
        shell: bash

      - name: Download VOICEVOX Resource
        run: |
          mkdir -p "${{ env.TEMPDIR }}/resource"
          curl -L "https://github.com/VOICEVOX/voicevox_resource/releases/download/${{ env.VOICEVOX_RESOURCE_VERSION }}/voicevox_resource.zip" -o "${{ env.TEMPDIR }}/resource/voicevox_resource.zip"
          unzip "${{ env.TEMPDIR }}/resource/voicevox_resource.zip" -d "${{ env.DEST }}/resource"
        shell: bash

      - name: Build with electron-builder
        run: pnpm electron-builder --publish never --config .electron-builder.config.cjs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Body
        id: generate_release_body
        run: |
          cp release_body/release_body.md release_body_final.md
          
          sed -i "s|{{EDITOR_VERSION}}|${{ env.VOICEVOX_EDITOR_VERSION }}|g" release_body_final.md
          sed -i "s|{{RESOURCE_VERSION}}|${{ env.VOICEVOX_RESOURCE_VERSION }}|g" release_body_final.md

          sed -i "感谢所有贡献者!" release_body_final.md
        shell: bash

      - name: Upload Artifact to Release
        # 这个 if 条件确保只有在需要发布时才执行
        if: (github.event.release.tag_name || github.event.inputs.voicevox_editor_version) != ''
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ github.event.inputs.prerelease }}
          tag_name: ${{ env.VOICEVOX_EDITOR_VERSION }}
          files: |-

            voicevox-${{ matrix.artifact_name }}-${{ env.VOICEVOX_EDITOR_VERSION }}.zip
          target_commitish: ${{ github.sha }}
          overwrite_files: true
          body_path: release_body_final.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
