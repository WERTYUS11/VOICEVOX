name: Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "VOICEVOX Editor çš„ç‰ˆæœ¬ä¿¡æ¯"
        required: true
      prerelease:
        description: "æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬"
        type: boolean
        default: true
      code_signing:
        description: "æ˜¯å¦è¿›è¡Œä»£ç ç­¾å"
        type: boolean
        default: false
      upload_artifact:
        description: "æ˜¯å¦å°†æ„å»ºäº§ç‰©ä¸Šä¼ ä¸º Artifacts (ç”¨äºè°ƒè¯•)"
        type: boolean
        default: false
      voicevox_engine_version:
        description: "VOICEVOX Engine ç‰ˆæœ¬ (latest/å…·ä½“ç‰ˆæœ¬å·)"
        required: false
        default: "latest"
      voicevox_resource_version:
        description: "VOICEVOX Resource ç‰ˆæœ¬ (latest/å…·ä½“ç‰ˆæœ¬å·)"
        required: false
        default: "latest"

env:
  VOICEVOX_ENGINE_VERSION: ${{ github.event.inputs.voicevox_engine_version || 'latest' }}
  VOICEVOX_RESOURCE_VERSION: ${{ github.event.inputs.voicevox_resource_version || 'latest' }}
  VOICEVOX_EDITOR_VERSION: ${{ github.event.release.tag_name || github.event.inputs.version || '999.999.999-develop' }}

defaults:
  run:
    shell: bash
    
permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact_name: linux-nvidia-prepackage
            artifact_path: dist_electron/linux-unpacked
            voicevox_engine_asset_name: linux-nvidia
            compressed_artifact_name: voicevox-linux-nvidia
            os: ubuntu-22.04
          - artifact_name: linux-cpu-x64-prepackage
            artifact_path: dist_electron/linux-unpacked
            voicevox_engine_asset_name: linux-cpu-x64
            compressed_artifact_name: voicevox-linux-cpu-x64
            os: ubuntu-22.04
          - artifact_name: windows-nvidia-prepackage
            artifact_path: dist_electron/win-unpacked
            voicevox_engine_asset_name: windows-nvidia
            compressed_artifact_name: voicevox-windows-nvidia
            os: windows-2022
          - artifact_name: windows-directml-prepackage
            artifact_path: dist_electron/win-unpacked
            voicevox_engine_asset_name: windows-directml
            compressed_artifact_name: voicevox-windows-directml
            os: windows-2022
          - artifact_name: macos-cpu-arm64-prepackage
            artifact_path: dist_electron/mac-arm64
            voicevox_engine_asset_name: macos-arm64
            compressed_artifact_name: voicevox-macos-cpu-arm64
            os: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".node-version"
          cache: "pnpm"

      - name: Install dependencies & Translation
        run: |
          pnpm i --no-frozen-lockfile
          if [ -f "script/zh-cn.js" ]; then
            node script/zh-cn.js
          elif [ -f "scripts/zh-cn.js" ]; then
            node scripts/zh-cn.js
          else
            echo "File not founded,Skipping step..."
          fi

      - name: Resolve Resource & Download Engine
        id: resolve-all
        run: |
          # è·å– Resource ç‰ˆæœ¬
          R_VER="${{ env.VOICEVOX_RESOURCE_VERSION }}"
          if [ "$R_VER" = "latest" ]; then
            R_VER=$(gh release --repo VOICEVOX/voicevox_resource view --json tagName --template '{{.tagName}}')
          fi
          echo "res_version=$R_VER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout Resource
        uses: actions/checkout@v4
        with:
          repository: VOICEVOX/voicevox_resource
          ref: ${{ steps.resolve-all.outputs.res_version }}
          path: resource

      - name: Download Engine
        uses: ./.github/actions/download-engine
        with:
          version: ${{ env.VOICEVOX_ENGINE_VERSION }}
          dest: ${{ github.workspace }}/voicevox_engine
          target: ${{ matrix.voicevox_engine_asset_name }}

      - name: Build Electron
        run: pnpm run electron:build --dir
        env:
          USE_HARD_LINKS: false

      - name: Prepare Prepackage & Merge
        run: |
          mv ${{ matrix.artifact_path }} ./prepackage
          if [[ "${{ matrix.os }}" == macos-* ]]; then
            mv voicevox_engine/ prepackage/VOICEVOX.app/Contents/Resources/vv-engine/
          else
            mv voicevox_engine/ prepackage/vv-engine/
          fi

      # --- ğŸ› ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šå…¨éƒ¨ä½¿ç”¨ 7z å‹ç¼© ---
      - name: Compress with 7z
        run: |
          OUTPUT_FILE="${{ matrix.compressed_artifact_name }}.7z"
          
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y p7zip-full
          fi
          
          # ä½¿ç”¨æœ€é«˜å‹ç¼©æ¯” (-mx=9) å’Œ è‡ªåŠ¨åˆ†å· (-v2000m) ç»•è¿‡ GitHub 2GB é™åˆ¶
          # æ³¨æ„ï¼šcd è¿›å…¥ç›®å½•å‹ç¼©å¯ä»¥ä¿è¯è§£å‹åä¸ä¼šå¤šå‡ºä¸€å±‚ prepackage æ–‡ä»¶å¤¹
          cd prepackage && 7z a "../$OUTPUT_FILE" ./* -mx=9 -v2000m && cd ..

      - name: Upload Artifact (Debug)
        if: github.event.inputs.upload_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: "*.7z*"

      - name: Create Release and Upload
        if: (github.event.release.tag_name || github.event.inputs.version) != ''
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ github.event.inputs.prerelease }}
          tag_name: ${{ env.VOICEVOX_EDITOR_VERSION }}
          files: |
            *.7z*
            dist_electron/*.dmg
            dist_electron/*.exe
            dist_electron/*.AppImage
          target_commitish: ${{ github.sha }}
          overwrite: true
