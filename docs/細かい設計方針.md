# 设计相关详细策略

## Vuex 与对话框

对话框被视为外部 API，允许从 Vuex Store 的 Action 内部调用。
这是为了方便，因为可以根据对话框的结果，将对话框前后的行为写在一个 Action 中。
对于某些类型的对话框，它们会直接作用于 View 来显示对话框 UI，这也同样被允许。

## EngineId、SpeakerId、StyleId

EngineId 是引擎的 ID，在全球范围内唯一且不可变。
SpeakerId 是说话者的 ID，在全球范围内唯一且不可变。它在不同引擎之间保持相同的 ID。
StyleId 是每个风格的 ID，只需要在每个引擎内唯一即可。

我们旨在实现这样的规范：要唯一确定一个声音，需要 (EngineId, SpeakerId, StyleId) 这三者的组合。
目前，由于语音合成 API 没有 SpeakerId 参数，所以声音是由 (EngineId, StyleId) 两者唯一确定的。
目前 StyleId 需要在每个引擎内唯一，但我们的目标是使其在每个说话者内唯一即可。

由于历史原因，VOICEVOX 中有时会混淆 SpeakerId 和 StyleId。
特别是当 SpeakerId 的类型是整数值时，它可能会与 StyleId 混淆。
（例如，将 StyleId 传递给引擎 API 的 SpeakerId 参数。）

StyleId 目前是整数类型，但我们计划将来将其改为 Uuid。

## 单文件组件（SFC，`.vue`文件）中 template、script、style 的顺序

请按照 `<template>`、`<script>`、`<style>` 的顺序编写。

## 错误处理（实验性运行中）

基本上，函数侧抛出异常，UI 侧捕获并显示错误对话框。
当抛出可能显示给用户的异常时，请使用 `DisplayableError` 并编写用户友好的消息。

## Zod 的 Schema 和类型定义

对于 Zod 的 Schema (`z.object`)，变量名应为 `[camelCaseName]Schema`；对于类型定义 (`z.infer`)，名称应为 `[PascalCaseName]Type`。

```ts
export const hogeFugaSchema = z.object({
  hoge: z.string(),
  fuga: z.number(),
});

export type HogeFugaType = z.infer<typeof hogeFugaSchema>;
```

## 多引擎

添加引擎有两种方式：安装 VVPP 文件，或指定引擎目录的路径。

|                      | VVPP                                 | 路径                                |
| :------------------- | :----------------------------------- | :---------------------------------- |
| `EngineInfo` 的 `type` | `"vvpp"`                             | `"path"`                            |
| 添加时的处理         | 将 zip 文件解压到指定文件夹          | 将引擎路径保存到 `config.json`      |
| 加载时的处理         | 从指定文件夹中读取                   | 读取 `config.json` 中保存的路径     |
| 删除时的处理         | 删除指定文件夹中的目录               | 从 `config.json` 中删除路径         |

## 默认引擎更新信息

默认引擎的更新信息以 JSON 格式管理。
更新信息中包含最新软件包（VVPP/VVPPP 文件）的 URL 和版本等。
软件包信息按操作系统、架构和设备进行分类。

文件格式如下：

```JSONC
{
  //[number] 文件结构版本（每次规范变更时递增）
  "formatVersion": 1,

  // Windows 的信息
  "windows": {
    "x64": {
      "CPU": {
        //[string] 版本
        "version": "x.x.x",

        // vvpp 和 vvppp 的信息
        "packages": [
          {
            //[string] 下载 URL
            "url": "https://example.com/example.vvpp",

            //[string] 文件名
            "name": "example.vvpp",

            //[number] 字节数
            "size": 123456,

            //[string(Optional)] 哈希值
            "hash": "xxxxxxx",
          },
          //...
        ]
      },
      "GPU/CPU": { /* 同上 */ }
    }
  },

  "macos": {
    "x64": {
      "CPU": { /* 同上 */ }
    },
    "arm64": {
      "CPU": { /* 同上 */ }
    }
  },

  "linux": {
    "x64": {
      "CPU": { /* 同上 */ },
      "GPU/CPU": { /* 同上 */ }
    }
  }
}

